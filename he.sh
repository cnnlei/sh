#!/bin/bash

#===================================================================================
# è„šæœ¬åç§°: he_tunnel_manager_fixed.sh
# è„šæœ¬åŠŸèƒ½: (ä¿®å¤ç‰ˆ) è§£å†³äº† "No buffer space available" é”™è¯¯
#           - [ä¿®å¤] ä½¿ç”¨è‡ªå®šä¹‰æ¥å£å(he-ipv6)å¹¶æ”¹ç”¨iproute2å‘½ä»¤, é¿å…sit0å†²çª
#           - è‡ªåŠ¨åˆ›å»ºå¹¶å¯ç”¨systemdå¼€æœºè‡ªå¯æœåŠ¡
#           - è‡ªåŠ¨æ£€æŸ¥å¹¶å®‰è£…net-toolsä¾èµ–
#           - ... (åŒ…å«ä¹‹å‰æ‰€æœ‰åŠŸèƒ½)
# ä½¿ç”¨æ–¹æ³•: sudo ./he_tunnel_manager_fixed.sh
#===================================================================================

# --- å…¨å±€é…ç½® ---
WORK_DIR="/he"
CONFIG_NAME="he.sh"
CONFIG_FILE_PATH="${WORK_DIR}/${CONFIG_NAME}"
# ã€é‡è¦ã€‘æ¥å£åä¸å†ä½¿ç”¨sit0/sit1, æ”¹ç”¨è‡ªå®šä¹‰åç§°é¿å…å†²çª
INTERFACE_NAME="he-ipv6" 
ROUTE_TABLE_ID="100"
LA_SERVER_IP="66.220.18.42"
SERVERS=(
    "66.220.18.42"    "ç¾å›½, æ´›æ‰çŸ¶ (Los Angeles, CA)"
    "216.66.80.30"    "ç¾å›½, å¼—é‡Œè’™ç‰¹ (Fremont, CA)"
    "216.66.84.42"    "ç¾å›½, é˜¿ä»€æœ¬ (Ashburn, VA)"
    "64.62.200.2"     "ç¾å›½, çº½çº¦ (New York, NY)"
    "216.66.87.14"    "ç¾å›½, èŠåŠ å“¥ (Chicago, IL)"
    "66.220.7.82"     "ç¾å›½, è¿ˆé˜¿å¯† (Miami, FL)"
    "216.66.88.98"    "ç¾å›½, è¾¾æ‹‰æ–¯ (Dallas, TX)"
    "216.66.86.114"   "ç¾å›½, è¥¿é›…å›¾ (Seattle, WA)"
    "209.51.181.2"    "è‹±å›½, ä¼¦æ•¦ (London, UK)"
    "195.10.195.10"   "å¾·å›½, æ³•å…°å…‹ç¦ (Frankfurt, DE)"
    "216.66.22.2"     "è·å…°, é˜¿å§†æ–¯ç‰¹ä¸¹ (Amsterdam, NL)"
    "216.66.38.58"    "ç‘å£«, è‹é»ä¸– (Zurich, CH)"
    "103.56.233.1"    "æ—¥æœ¬, ä¸œäº¬ (Tokyo, JP)"
    "184.105.251.94"  "ä¸­å›½, é¦™æ¸¯ (Hong Kong)"
    "184.105.220.102" "æ–°åŠ å¡ (Singapore)"
)
# --- å…¨å±€é…ç½®ç»“æŸ ---


#================================================
# å‡½æ•° 1: ã€ä¿®å¤ã€‘ç”Ÿæˆæ›´ç¨³å®šå¯é çš„é…ç½®æ–‡ä»¶æ¨¡æ¿
#================================================
generate_config_template() {
    # æ¨¡æ¿å·²é‡æ„ï¼Œä½¿ç”¨iproute2(ipå‘½ä»¤)å¹¶åˆ›å»ºè‡ªå®šä¹‰æ¥å£
    cat <<EOF > "$CONFIG_FILE_PATH"
#!/bin/bash
# HE.net IPv6 Tunnel Configuration Script (v2 - iproute2)
# Generated by he_tunnel_manager_fixed.sh

# --- Variables (ç”±ç®¡ç†è„šæœ¬ä¿®æ”¹) ---
REMOTE_IPV4="66.220.18.42"
IPV6_ROUTED_64_SEGMENT="c:fa"
IPV6_ROUTED_48_SEGMENT="f1c0"

# --- Static definitions (ç”±ç®¡ç†è„šæœ¬ç”Ÿæˆ) ---
INTERFACE_NAME="${INTERFACE_NAME}"
ROUTE_TABLE_ID="${ROUTE_TABLE_ID}"
# è·å–æœ¬æœºä¸»ç½‘å¡çš„å…¬ç½‘IPä½œä¸ºéš§é“æœ¬åœ°ç«¯ç‚¹
LOCAL_IPV4=\$(ip -4 route get 8.8.8.8 | awk '{print \$7}' | head -n 1)

# --- Clean up previous configuration ---
echo "Cleaning up old tunnel configuration..."
if ip link show \$INTERFACE_NAME &> /dev/null; then
    ip link set dev \$INTERFACE_NAME down
    ip tunnel del \$INTERFACE_NAME
fi
# æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ—§è·¯ç”±è§„åˆ™
ip -6 rule del from 2001:470:\${IPV6_ROUTED_64_SEGMENT}::/64 table \$ROUTE_TABLE_ID &> /dev/null
ip -6 rule del from 2001:470:\${IPV6_ROUTED_48_SEGMENT}::/48 table \$ROUTE_TABLE_ID &> /dev/null
ip -6 route flush table \$ROUTE_TABLE_ID &> /dev/null

# --- Setup new configuration ---
echo "Setting up new tunnel on interface '\$INTERFACE_NAME'..."
# 1. åˆ›å»ºSITéš§é“æ¥å£
ip tunnel add \$INTERFACE_NAME mode sit remote \${REMOTE_IPV4} local \${LOCAL_IPV4} ttl 255
# 2. å¯ç”¨æ¥å£
ip link set dev \$INTERFACE_NAME up
# 3. åœ¨éš§é“æ¥å£ä¸Šé…ç½®IPv6åœ°å€
ip addr add 2001:470:\${IPV6_ROUTED_64_SEGMENT}::2/64 dev \$INTERFACE_NAME
ip addr add 2001:470:\${IPV6_ROUTED_48_SEGMENT}::1/48 dev \$INTERFACE_NAME
# 4. è®¾ç½®MTU
ip link set dev \$INTERFACE_NAME mtu 1280

# --- Setup routing ---
echo "Setting up routing rules..."
ip -6 route add default via 2001:470:\${IPV6_ROUTED_64_SEGMENT}::1 dev \$INTERFACE_NAME table \$ROUTE_TABLE_ID
ip -6 rule add from 2001:470:\${IPV6_ROUTED_64_SEGMENT}::/64 table \$ROUTE_TABLE_ID
ip -6 rule add from 2001:470:\${IPV6_ROUTED_48_SEGMENT}::/48 table \$ROUTE_TABLE_ID

echo "Configuration applied."
EOF
}

#================================================
# å…¶ä»–å‡½æ•° (check_dependencies, interactive_edit_tunnel, setup_systemd_service)
# å’Œä¸»æµç¨‹ (main) ä¸ä¸Šä¸€ç‰ˆå®Œå…¨ç›¸åŒï¼Œè¿™é‡Œçœç•¥ä»¥èŠ‚çº¦ç¯‡å¹…ã€‚
# è¯·ç¡®ä¿ä½ å¤åˆ¶çš„æ˜¯åŒ…å«ä¸‹é¢æ‰€æœ‰ä»£ç çš„å®Œæ•´è„šæœ¬ã€‚
#================================================
check_dependencies() {
    echo "ğŸ” æ­£åœ¨æ£€æŸ¥ä¾èµ–..."
    local dep_ok=true
    if ! command -v ip &> /dev/null; then
        echo "âŒ å…³é”®å‘½ä»¤ 'ip' (æ¥è‡ª iproute2) æœªæ‰¾åˆ°ã€‚è„šæœ¬æ— æ³•è¿è¡Œã€‚"
        dep_ok=false
    fi
    if ! command -v awk &> /dev/null; then
        echo "âŒ å…³é”®å‘½ä»¤ 'awk' æœªæ‰¾åˆ°ã€‚è„šæœ¬æ— æ³•è¿è¡Œã€‚"
        dep_ok=false
    fi
    if ! $dep_ok; then return 1; else echo "âœ”ï¸ æ ¸å¿ƒä¾èµ–å·²æ»¡è¶³ã€‚"; return 0; fi
}
interactive_edit_tunnel() {
    local config_path="$1"
    local current_64=$(grep 'IPV6_ROUTED_64_SEGMENT=' "$config_path" | cut -d'"' -f2)
    local current_48=$(grep 'IPV6_ROUTED_48_SEGMENT=' "$config_path" | cut -d'"' -f2)
    local current_ip=$(grep 'REMOTE_IPV4=' "$config_path" | cut -d'"' -f2)
    if [ -z "$current_64" ] || [ -z "$current_48" ] || [ -z "$current_ip" ]; then echo "âŒ é”™è¯¯: æ— æ³•è§£æ '$config_path' æ–‡ä»¶ã€‚"; return 1; fi
    echo "=================================================="
    echo "    äº¤äº’å¼ HE.net IPv6 éš§é“é…ç½®æ›´æ–°å·¥å…·"
    echo "=================================================="
    local current_location="æœªçŸ¥"; for ((i=0; i<${#SERVERS[@]}; i+=2)); do if [[ "${SERVERS[i]}" == "$current_ip" ]]; then local current_location="${SERVERS[i+1]}"; break; fi; done
    echo "æ­£åœ¨ç¼–è¾‘æ–‡ä»¶: $config_path"
    echo "å½“å‰é…ç½®å€¼å¦‚ä¸‹:"
    echo "  - /64 åœ°å€æ®µ: $current_64"
    echo "  - /48 åœ°å€æ®µ: $current_48"
    echo "  - éš§é“æœåŠ¡å™¨: $current_ip ($current_location)"
    echo "--------------------------------------------------"
    echo "è¯·è¾“å…¥æ–°çš„é…ç½®å€¼ã€‚å¦‚æœæŸé¡¹ä¸æƒ³æ›´æ”¹ï¼Œå¯ç›´æ¥å›è½¦ã€‚"
    echo
    read -p "â¡ï¸ è¯·è¾“å…¥æ–°çš„ /64 åœ°å€æ®µ (ä¾‹å¦‚ c:fa) [$current_64]: " new_64
    [ -z "$new_64" ] && new_64=$current_64
    read -p "â¡ï¸ è¯·è¾“å…¥æ–°çš„ /48 åœ°å€æ®µ (ä¾‹å¦‚ f1c0) [$current_48]: " new_48
    [ -z "$new_48" ] && new_48=$current_48
    local new_ip=$current_ip; local perform_ip_change=false
    if [[ "$current_ip" != "$LA_SERVER_IP" ]]; then
        read -p "âš ï¸ å½“å‰æœåŠ¡å™¨ä¸æ˜¯æ´›æ‰çŸ¶, è¦æ›´æ¢å—? (y/N): " choice
        if [[ "$choice" =~ ^[yY] ]]; then perform_ip_change=true; fi
    else
        perform_ip_change=true
    fi
    if $perform_ip_change; then
        echo; echo "--- è¯·ä»ä»¥ä¸‹åˆ—è¡¨ä¸­é€‰æ‹©æ–°çš„éš§é“æœåŠ¡å™¨ ---"
        for ((i=0; i<${#SERVERS[@]}; i+=2)); do local idx=$((i/2 + 1)); printf " %2d. %-15s %s\n" "$idx" "${SERVERS[i]}" "${SERVERS[i+1]}"; done
        echo "-------------------------------------------"
        local current_idx_str=""; for ((i=0; i<${#SERVERS[@]}; i+=2)); do if [[ "${SERVERS[i]}" == "$current_ip" ]]; then local current_idx_str="é»˜è®¤: $((i/2 + 1))"; break; fi; done
        read -p "â¡ï¸ è¯·è¾“å…¥åºå· [$current_idx_str]: " new_idx
        if [[ "$new_idx" =~ ^[0-9]+$ ]] && [ "$new_idx" -ge 1 ] && [ "$new_idx" -le $((${#SERVERS[@]}/2)) ]; then
            new_ip=${SERVERS[($new_idx-1)*2]}
        else
            echo "â„¹ï¸ è¾“å…¥æ— æ•ˆæˆ–ä¸ºç©º, ä¿æŒå½“å‰IPä¸å˜ã€‚"
        fi
    fi
    echo "--------------------------------------------------"
    echo "æœ€ç»ˆé…ç½®å¦‚ä¸‹:"
    echo "  - æ–° /64 æ®µ: $new_64"
    echo "  - æ–° /48 æ®µ: $new_48"
    echo "  - æ–°æœåŠ¡å™¨IP: $new_ip"
    echo "--------------------------------------------------"
    read -p "ç¡®è®¤è¦å°†ä»¥ä¸Šæ›´æ”¹å†™å…¥ '$config_path' å—ï¼Ÿ(y/N): " confirm
    if [[ ! "$confirm" =~ ^[yY] ]]; then echo "ğŸš« æ“ä½œå·²å–æ¶ˆã€‚"; return 1; fi
    echo "âš™ï¸ æ­£åœ¨æ›´æ–°é…ç½®æ–‡ä»¶: $config_path ..."
    sed -i.bak -e "s/REMOTE_IPV4=\".*\"/REMOTE_IPV4=\"$new_ip\"/" -e "s/IPV6_ROUTED_64_SEGMENT=\".*\"/IPV6_ROUTED_64_SEGMENT=\"$new_64\"/" -e "s/IPV6_ROUTED_48_SEGMENT=\".*\"/IPV6_ROUTED_48_SEGMENT=\"$new_48\"/" "$config_path"
    echo "âœ”ï¸ é…ç½®æ–‡ä»¶æ›´æ–°å®Œæ¯•ï¼åŸå§‹æ–‡ä»¶å·²å¤‡ä»½ä¸º ${config_path}.bak"
    return 0
}
setup_systemd_service() {
    local service_name="he-tunnel.service"
    local service_path="/etc/systemd/system/${service_name}"
    if ! command -v systemctl &> /dev/null; then echo "â„¹ï¸ æœªæ£€æµ‹åˆ° systemd, æ— æ³•è®¾ç½®å¼€æœºè‡ªå¯æœåŠ¡ã€‚"; return; fi
    if systemctl is-enabled "$service_name" &> /dev/null; then echo "â„¹ï¸ å¼€æœºè‡ªå¯æœåŠ¡ ('$service_name') å·²ç»å¯ç”¨, æ— éœ€é‡å¤è®¾ç½®ã€‚"; return; fi
    echo
    read -p "ğŸ’¡ æ˜¯å¦è¦å°† '$CONFIG_FILE_PATH' è®¾ç½®ä¸ºå¼€æœºè‡ªå¯? (Y/n): " choice
    if [[ "$choice" =~ ^[nN]$ ]]; then echo "â„¹ï¸ ç”¨æˆ·é€‰æ‹©ä¸è®¾ç½®å¼€æœºè‡ªå¯ã€‚"; return; fi
    echo "âš™ï¸ æ­£åœ¨åˆ›å»º systemd æœåŠ¡: $service_path..."
    cat << EOF > "$service_path"
[Unit]
Description=HE.net IPv6 Tunnel Setup (managed by he_tunnel_manager)
After=network-online.target
Wants=network-online.target
[Service]
Type=oneshot
ExecStart=$CONFIG_FILE_PATH
RemainAfterExit=yes
[Install]
WantedBy=multi-user.target
EOF
    echo "âš™ï¸ æ­£åœ¨å¯ç”¨æœåŠ¡..."
    systemctl daemon-reload
    systemctl enable "$service_name"
    if systemctl is-enabled "$service_name" &> /dev/null; then echo "âœ”ï¸ æˆåŠŸ! '$CONFIG_FILE_PATH' å°†åœ¨ä¸‹æ¬¡å¼€æœºæ—¶è‡ªåŠ¨è¿è¡Œã€‚"; else echo "âŒ é”™è¯¯: è®¾ç½®å¼€æœºè‡ªå¯å¤±è´¥ã€‚è¯·æ£€æŸ¥ systemd æ—¥å¿—ã€‚"; fi
}
main() {
    if [ "$(id -u)" -ne 0 ]; then echo "âŒ é”™è¯¯ï¼šæ­¤è„šæœ¬éœ€è¦ä»¥ root æƒé™è¿è¡Œã€‚"; exit 1; fi
    check_dependencies
    if [ $? -ne 0 ]; then exit 1; fi
    echo "--------------------------------------------------"
    echo "âš™ï¸ å‡†å¤‡å·¥ä½œç¯å¢ƒ..."
    mkdir -p "$WORK_DIR"
    if [ ! -f "$CONFIG_FILE_PATH" ]; then
        echo "  -> é…ç½®æ–‡ä»¶ '$CONFIG_FILE_PATH' ä¸å­˜åœ¨, æ­£åœ¨ç”Ÿæˆæ¨¡æ¿..."
        generate_config_template
        chmod +x "$CONFIG_FILE_PATH"
        echo "âœ”ï¸ æ¨¡æ¿ç”ŸæˆæˆåŠŸã€‚"
    else
        echo "â„¹ï¸ é…ç½®æ–‡ä»¶ '$CONFIG_FILE_PATH' å·²å­˜åœ¨, å°†ç›´æ¥è¿›è¡Œç¼–è¾‘ã€‚"
    fi
    echo
    interactive_edit_tunnel "$CONFIG_FILE_PATH"
    if [ $? -ne 0 ]; then echo; echo "âŒ ç¼–è¾‘è¿‡ç¨‹è¢«å–æ¶ˆæˆ–å¤±è´¥, è„šæœ¬å·²ç»ˆæ­¢ã€‚"; exit 1; fi
    echo
    read -p "âœ… é…ç½®å·²æ›´æ–°, æ˜¯å¦ç«‹å³æ‰§è¡Œ '$CONFIG_FILE_PATH' æ¥åº”ç”¨ç½‘ç»œè®¾ç½®? (Y/n): " execute_choice
    if [[ ! "$execute_choice" =~ ^[nN]$ ]]; then
        echo "ğŸš€ æ­£åœ¨æ‰§è¡Œé…ç½®è„šæœ¬..."
        echo "-------------------------------------------"
        bash "$CONFIG_FILE_PATH"
        echo "-------------------------------------------"
        echo "ğŸ‰ æ‰€æœ‰æ“ä½œå®Œæˆï¼"
        setup_systemd_service
    else
        echo "â„¹ï¸ ç”¨æˆ·é€‰æ‹©ä¸æ‰§è¡Œã€‚é…ç½®å·²ä¿å­˜åœ¨ '$CONFIG_FILE_PATH'ã€‚"
    fi
    exit 0
}
main
